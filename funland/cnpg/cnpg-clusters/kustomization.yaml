apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Include all CNPG cluster definitions
resources:
  - authentik-cnpg-cluster.yaml
  - vikunja-cnpg-cluster.yaml
  - n8n-cnpg-cluster.yaml
  - vaultwarden-cnpg-cluster.yaml
  - immich-cnpg-cluster.yaml
  - scheduled-backups.yaml  # Daily backups at midnight

# Use the B2 backup component to add backup config to all clusters
components:
  - ../cnpg-components/b2-backup

# Customize the backup path for each cluster
patches:
  - target:
      kind: Cluster
      name: authentik-dbc
    patch: |-
      - op: replace
        path: /spec/backup/barmanObjectStore/destinationPath
        value: s3://batcave-kubernetes/funland/postgres-backups/authentik
      - op: add
        path: /spec/backup/barmanObjectStore/tags/cluster
        value: authentik-dbc

  - target:
      kind: Cluster
      name: vikunja-dbc
    patch: |-
      - op: replace
        path: /spec/backup/barmanObjectStore/destinationPath
        value: s3://batcave-kubernetes/funland/postgres-backups/vikunja
      - op: add
        path: /spec/backup/barmanObjectStore/tags/cluster
        value: vikunja-dbc

  - target:
      kind: Cluster
      name: n8n-dbc
    patch: |-
      - op: replace
        path: /spec/backup/barmanObjectStore/destinationPath
        value: s3://batcave-kubernetes/funland/postgres-backups/n8n
      - op: add
        path: /spec/backup/barmanObjectStore/tags/cluster
        value: n8n-dbc

  - target:
      kind: Cluster
      name: vaultwarden-dbc
    patch: |-
      - op: replace
        path: /spec/backup/barmanObjectStore/destinationPath
        value: s3://batcave-kubernetes/funland/postgres-backups/vaultwarden
      - op: add
        path: /spec/backup/barmanObjectStore/tags/cluster
        value: vaultwarden-dbc

  - target:
      kind: Cluster
      name: immich-dbc
    patch: |-
      - op: replace
        path: /spec/backup/barmanObjectStore/destinationPath
        value: s3://batcave-kubernetes/funland/postgres-backups/immich
      - op: add
        path: /spec/backup/barmanObjectStore/tags/cluster
        value: immich-dbc
